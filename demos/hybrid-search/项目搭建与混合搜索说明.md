# OceanBase 混合搜索项目搭建与说明

## 📋 项目概述

基于 Next.js 15 和 OceanBase 数据库的智能电影搜索系统，支持向量搜索、全文搜索和混合搜索。

## 🚀 快速搭建

### 1. 环境要求

- Node.js 18+
- OceanBase 数据库（支持混搜 4.1 版本及以上）
- 百炼 Embeddings API Key

### 2. 安装依赖

```bash
npm install
```

### 3. 环境配置

创建 `.env` 文件：

```env
# 数据库连接
DATABASE_URL_BACK="mysql://username:password@host:port/database"

# 百炼 Embeddings 配置
EMBEDDING_APIKEY="your-api-key"
EMBEDDING_PROVIDER="openai"
EMBEDDING_MODEL="text-embedding-v4"
DIMENSIONS="1024"
BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
```

### 4. 初始化项目

```bash
# 生成 Prisma 客户端
npm run setup
```

### 5. 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:3000/hybrid-search 开始使用。

## 🔍 混合搜索原理

### 什么是混合搜索？

混合搜索（Hybrid Search）结合了两种搜索方式：

1. **向量搜索（Vector Search）**：基于语义相似度，理解查询意图
2. **关键词搜索（Keyword Search）**：基于文本匹配，精确查找关键词

### 技术实现

项目使用 OceanBase 的 `hybrid_search` 函数实现混合搜索：

```sql
SELECT * FROM hybrid_search('movies',
  '{
    "query": {
      "query_string": {
        "fields": ["directors^2.5", "actors^2.5", "genres^2.5", "summary"],
        "query": "搜索关键词"
      }
    },
    "knn": [{
      "field": "embedding",
      "k": 50,
      "query_vector": [向量数组]
    }],
    "rank": {
      "rrf": {}
    },
    "hybrid_radio": "0.7",
    "size": "50"
  }')
```

### 核心参数说明

- **hybrid_radio**: 混合权重比例（0-1），0.7 表示向量搜索占 70%，关键词搜索占 30%
- **knn**: K 近邻搜索配置，`k=50` 表示返回最相似的 50 条结果
- **query_string**: 关键词搜索配置，支持字段权重（`^2.5` 表示权重）
- **rrf**: Reciprocal Rank Fusion 排序算法，融合两种搜索结果

### 工作流程

1. **查询向量化**：使用百炼 Embeddings API 将用户查询转换为向量
2. **并行搜索**：
   - 向量搜索：在 embedding 字段中查找相似向量
   - 关键词搜索：在 directors、actors、genres、summary 字段中匹配
3. **结果融合**：使用 RRF 算法合并两种搜索结果
4. **排序返回**：按综合评分排序，返回最相关的结果

## 📁 项目结构

```
oceanbase-search/
├── app/
│   ├── api/                    # API 路由
│   │   ├── multi-hybrid-search/  # 混合搜索接口
│   │   ├── vector-search/        # 向量搜索接口
│   │   └── full-text-search/     # 全文搜索接口
│   └── hybrid-search/          # 搜索页面
├── lib/
│   ├── multi-prisma.ts         # 多数据库管理
│   └── hooks/                  # React Hooks
├── middleware/
│   └── model.js                # Embedding 模型初始化
└── prisma/
    └── schema.prisma           # 数据库模式
```

## 🎯 核心功能

### 1. 多数据库支持

通过 `MultiDatabaseManager` 管理多个数据库连接：

```typescript
const multiDB = MultiDatabaseManager.getInstance()
const client = multiDB.getClient('back')
```

### 2. 智能降级

如果向量搜索失败，自动降级到文本搜索，确保服务可用性。

### 3. 性能优化

- 并行数据库查询
- 请求超时控制（25 秒）
- BigInt 序列化处理

## 📚 参考资源

- [OceanBase 混合搜索官方文档](https://open.oceanbase.com/blog/23300329984)
- [百炼 Embeddings API](https://dashscope.aliyuncs.com)

## 🔧 常见问题

**Q: 混合搜索失败怎么办？**  
A: 检查数据库是否支持 `hybrid_search` 函数，确保 OceanBase 版本 >= 4.1

**Q: 向量维度不匹配？**  
A: 确保 `.env` 中的 `DIMENSIONS` 与数据库中的向量维度一致（默认 1024）

**Q: API Key 错误？**  
A: 检查 `EMBEDDING_APIKEY` 是否正确配置，确保有百炼 API 访问权限
